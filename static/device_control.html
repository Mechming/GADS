<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Device Control</title>
</head>
<style>
    #image-stream {
        height: 1136px;
        width: 640px;
        margin-top: 20px;
        margin-left: 10px;
    }

    #container-div {
        height: 100%;
        width: 100%;
        display: flex;
    }

    #actions-div,
    #elements-div,
    #stream-div {
        display: inline-block;
        *display: inline;
        zoom: 1;
        vertical-align: top;
    }

    #actions-div {
        width: 25%;
        margin-left: 10px;
    }

    #elements-div {
        margin-left: 20px;
        /* border: 1px solid #000; */
    }

    #device-info-table,
    th,
    td {
        border: 1px solid black;
        border-collapse: collapse;
    }

    td {
        text-align: center;
    }

    #loading {
        visibility: hidden;
        position: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        text-align: center;
        opacity: 0.7;
        background-color: #fff;
        z-index: 99;
    }

    #loading-image {
        position: relative;
    }

    #page-source {
        width: 100%;
        margin-left: 10px;
    }
</style>

<body>
    <div id="loading">
        <img id="loading-image" src="/static/images/loader.gif">
    </div>
    <div class="topnav">
        <link href="/static/css/top_navigation_style.css" rel="stylesheet">
        <a href="/">Home</a>
        <a href="configuration.html">Project configuration</a>
        <a href="ios-containers.html">iOS containers</a>
        <a href="android-containers.html">Android containers</a>
        <a href="project-logs.html">Project logs</a>
        <a class="active" href="device-control.html">Device Control</a>
        <a href="swagger/index.html" target="_blank">Swagger</a>
    </div>
    <div id="container-div">
        <div id="stream-div">
            <img id="image-stream"></img>
        </div>
        <div id="actions-div">
            <select id="device-dropdown" name="devices" onchange="updateDeviceInfo()"></select>
            <h3>Device Config Info</h3>
            <table id="device-info-table" style="width:100%">
                <tr>
                    <th>Device name:</th>
                    <td id="device-name"></td>
                </tr>
                <tr>
                    <th>Device OS version:</th>
                    <td id="device-os-version"></td>
                </tr>
                <tr>
                    <th>Device UDID:</th>
                    <td id="device-udid"></td>
                </tr>
                <tr>
                    <th>Appium Port:</th>
                    <td id="appium-port"></td>
                </tr>
                <tr>
                    <th>WDA Port:</th>
                    <td id="wda-port"></td>
                </tr>
                <tr>
                    <th>WDA Mjpeg Port:</th>
                    <td id="wda-mjpeg-port"></td>
                </tr>
                <tr>
                    <th>WDA URL:</th>
                    <td id="wda-url"></td>
                </tr>
                <tr>
                    <th>WDA Stream URL:</th>
                    <td id="wda-stream-url"></td>
                </tr>
                <tr>
                    <th>WDA session ID:</th>
                    <td id="wda-session-id">No session</td>
                </tr>
            </table>
            <h4>Installed apps</h4>
            <select id="installed-apps-dropdown" name="installed-apps"></select>
            <button id="uninstall-app" onclick="uninstallApp()">Uninstall app</button>
            <h4>Installable apps</h4>
            <select id="installable-apps-dropdown" name="installable-apps"></select>
            <button id="install-app" onclick="installApp()">Install app</button>
            <h4>Create WDA session</h4>
            <input id="bundleid-name" type="text"></input>
            <button id="create-wda-session" onclick="createWDASession()">
                Create session
            </button>
            <button id="delete-wda-session" onclick="deleteWDASession()" disabled>
                Delete session
            </button>
            <button id="get-page-source" onclick="getPageSource()">Get page source</button>
            <h4>Element interactions</h4>
            <select id="element-query-type">
                <option value="xpath" selected>Xpath</option>
                <option value="class chain">Class chain</option>
                <option value="accessibility id">Accessibility ID</option>
                <option value="predicate string">Predicate string</option>
            </select>
            <input id="element-query" type="text"></input>
            <button id="query-elements" onclick="createElementsDropdown()">
                Query elements
            </button>
            <select id="found-elements-dropdown"></select>
            <button id="tap-element" onclick="tapElement()">
                Tap element
            </button>
        </div>
        <div id="elements-div">
            <div>
                <h3>Page source</h3>
                <div id="page-source"></div>
            </div>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
</body>

<script>
    window.addEventListener("DOMContentLoaded", function () {
        getDeviceControlInfo();
        changeStream()
        updateDeviceInfo()
    });

    function getDeviceControlInfo() {
        $.ajax({
            async: false,
            type: "GET",
            url: "/devices/device-control",
            success: function (data) {
                createDeviceDropdown(data)
            },
            error: function (data) {
                alert("Broken data");
            }
        });
    }

    function updateDeviceInfo(data) {
        $.ajax({
            async: false,
            type: "GET",
            url: "/devices/device-control",
            success: function (data) {
                // Get the device UDID from the value of the selected option
                var device_udid = $("#device-dropdown").val();

                var response = JSON.parse(data)
                for (let i = 0; i < response["ios-devices-info"].length; i++) {
                    if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                        $("#device-name").text(response["ios-devices-info"][i].deviceConfig.device_name)
                        $("#device-os-version").text(response["ios-devices-info"][i].deviceConfig.device_os_version)
                        $("#device-udid").text(response["ios-devices-info"][i].deviceConfig.device_udid)
                        $("#appium-port").text(response["ios-devices-info"][i].deviceConfig.appium_port)
                        $("#wda-port").text(response["ios-devices-info"][i].deviceConfig.wda_port)
                        $("#wda-mjpeg-port").text(response["ios-devices-info"][i].deviceConfig.wda_mjpeg_port)
                        $("#wda-stream-url").text(response["ios-devices-info"][i].deviceConfig.wda_stream_url)
                        $("#wda-url").text(response["ios-devices-info"][i].deviceConfig.wda_url)
                    }
                }
                createIOSAppsDropdown(data)
                createInstallableAppsDropdown(data)
                changeStream();
            },
            error: function (data) {
                alert("Broken data");
            }
        });
    }

    function createDeviceDropdown(data) {
        let device_dropdown = $('#device-dropdown');

        device_dropdown.empty();

        device_dropdown.append('<option>Choose device</option>');

        device_dropdown.prop('selectedIndex', 0);
        var response = JSON.parse(data)
        for (let i = 0; i < response["running-containers"].length; i++) {
            var match = response["running-containers"][i].match(/[^-]*$/)
            device_dropdown.append($('<option></option>').attr('value', match[0]).text(response["running-containers"][i]));
        }
    }

    function createIOSAppsDropdown(data) {
        // Get the device UDID from the value of the selected option
        var device_udid = $("#device-dropdown").val();

        let apps_dropdown = $('#installed-apps-dropdown');
        apps_dropdown.empty();
        apps_dropdown.prop('selectedIndex', 0);

        var response = JSON.parse(data)
        for (let i = 0; i < response["ios-devices-info"].length; i++) {
            if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                for (let x = 0; x < response["ios-devices-info"][i].installedAppsBundleIDs.length; x++) {
                    apps_dropdown.append($('<option></option>').attr('value', response["ios-devices-info"][i].installedAppsBundleIDs[x]).text(response["ios-devices-info"][i].installedAppsBundleIDs[x]));
                }
            }
        }
    }

    function createInstallableAppsDropdown(data) {
        // Get the device UDID from the value of the selected option
        var device_udid = $("#device-dropdown").val();

        let apps_dropdown = $('#installable-apps-dropdown');

        let container_name = $("#device-dropdown option:selected").text()

        apps_dropdown.empty();
        apps_dropdown.prop('selectedIndex', 0);

        var response = JSON.parse(data)
        for (let i = 0; i < response["installable-apps"].length; i++) {
            if (container_name.includes("ios_device") && response["installable-apps"][i].includes(".ipa") || response["installable-apps"][i].includes(".app")) {
                apps_dropdown.append($('<option></option>').attr('value', response["installable-apps"][i]).text(response["installable-apps"][i]));
            } else if (container_name.includes("android_device") && response["installable-apps"][i].includes(".apk")) {
                apps_dropdown.append($('<option></option>').attr('value', response["installable-apps"][i]).text(response["installable-apps"][i]));
            }
        }
    }

    function changeStream() {
        // Get the device UDID from the value of the selected option
        var device_udid = $("#device-dropdown").val();
        let image_stream = $('#image-stream')
        $.ajax({
            async: false,
            type: "GET",
            url: "/devices/device-control",
            success: function (data) {
                var response = JSON.parse(data)
                for (let i = 0; i < response["ios-devices-info"].length; i++) {
                    if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                        console.log("Changing stream to this url: " + response["ios-devices-info"][i].deviceConfig.wda_stream_url)
                        image_stream.attr('src', response["ios-devices-info"][i].deviceConfig.wda_stream_url)
                    }
                }
            }
        });
    }

    function uninstallApp() {
        var bundle_id = $('#installed-apps-dropdown').val();
        var device_udid = $("#device-dropdown").val();

        $.ajax({
            contentType: 'application/json',
            async: true,
            type: "POST",
            data: JSON.stringify({ "bundle_id": bundle_id }),
            url: "/ios-devices/" + device_udid + "/uninstall-app",
            success: function (data) {
                swal("Info message", "Successfully uninstalled app with bundleID:'" + bundle_id + "'", "success")
                    .then(() => {
                        location.reload();
                    });
            },
            error: function (data) {
                swal("Uninstall app error", $.parseJSON(data.responseText).error_message, "error")
            }
        });
    }

    function installApp() {
        var ipa_name = $('#installable-apps-dropdown').val();
        var device_udid = $("#device-dropdown").val();

        /* Show loading indicator until response is returned */
        $('#loading').css("visibility", "visible");

        $.ajax({
            contentType: 'application/json',
            async: true,
            type: "POST",
            data: JSON.stringify({ "ipa_name": ipa_name }),
            url: "/ios-devices/" + device_udid + "/install-app",
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                swal("Info message", "Successfully installed app :'" + ipa_name + "'", "success")
                    .then(() => {
                        location.reload();
                    });
            },
            error: function (data) {
                $('#loading').css("visibility", "hidden");
                swal("Install app error", $.parseJSON(data.responseText).error_message, "error")
            }
        });
    }

    function createWDASession() {
        let wda_url = $("#wda-url").text()
        let wda_session = $("#wda-session-id")
        let bundle_id = $("#bundleid-name").val()
        let json = JSON.stringify({
            "capabilities": {
                "firstMatch": [
                    {
                        "bundleId": "" + bundle_id + "",
                        "arguments": [],
                        "environment": {},
                        "eventloopIdleDelaySec": 0,
                        "shouldWaitForQuiescence": true,
                        "shouldUseTestManagerForVisibilityDetection": false,
                        "maxTypingFrequency": 60,
                        "shouldUseSingletonTestManager": true,
                        "shouldTerminateApp": true,
                        "forceAppLaunch": true,
                        "useNativeCachingStrategy": true,
                        "forceSimulatorSoftwareKeyboardPresence": false
                    }
                ],
                "alwaysMatch": {}
            }
        })
        console.log(json)
        /* Show loading indicator until response is returned */
        $('#loading').css("visibility", "visible");

        $.ajax({
            async: false,
            type: "POST",
            url: wda_url + "/session",
            data: json,
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                wda_session.text(data.sessionId)
            },
            error: function (data) {
                $('#loading').css("visibility", "hidden");
                swal("Error", "Could not start session for bundleID:" + bundle_id, "error")
            }
        });
    }

    function deleteWDASession() {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()

        /* Show loading indicator until response is returned */
        $('#loading').css("visibility", "visible");

        $.ajax({
            async: true,
            type: "DELETE",
            url: wda_url + "/session/" + wda_session_id,
            success: function () {
                $('#loading').css("visibility", "hidden");
                wda_session.text("No session")
            },
            error: function () {
                $('#loading').css("visibility", "hidden");
                swal("Error", "Could not delete session for bundleID:" + wda_session_id, "error")
            }
        });
    }

    function getPageSource() {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()
        let page_source = $("#page-source")

        /* Show loading indicator until response is returned */
        $('#loading').css("visibility", "visible");

        $.ajax({
            async: true,
            type: "GET",
            url: wda_url + "/session/" + wda_session_id + "/source?format=json",
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                page_source.text(JSON.stringify(data))
            },
            error: function () {
                $('#loading').css("visibility", "hidden");
                page_source.text("No source")
            }
        });
    }

    function createElementsDropdown() {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()
        let query_type = $('#element-query-type option:selected').val();
        let query_string = $("#element-query").val()
        let found_elements = $('#found-elements-dropdown');

        console.log("QUERY TYPE")
        console.log(query_type)

        found_elements.empty();
        found_elements.append('<option>Choose element</option>');
        found_elements.prop('selectedIndex', 0);

        let json = JSON.stringify({
            "using": query_type,
            "value": query_string
        })

        /* Show loading indicator until response is returned */
        $('#loading').css("visibility", "visible");

        $.ajax({
            async: true,
            type: "POST",
            data: json,
            url: wda_url + "/session/" + wda_session_id + "/elements",
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                for (let i = 0; i < data.value.length; i++) {
                    found_elements.append($('<option></option>').attr('value', data.value[i].ELEMENT).text(data.value[i].ELEMENT));
                }

            }
        });
    }

    function tapElement() {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()
        let element_id = $('#found-elements-dropdown option:selected').val();

        /* Show loading indicator until response is returned */
        $('#loading').css("visibility", "visible");

        $.ajax({
            async: true,
            type: "POST",
            data: "{}",
            url: wda_url + "/session/" + wda_session_id + "/element/" + element_id + "/click",
            success: function () {
                $('#loading').css("visibility", "hidden");
            },
            error: function () {
                $('#loading').css("visibility", "hidden");
            }
        });
    }
</script>

</html>