<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Device Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/skin-lion/ui.fancytree.min.css" />
</head>
<style>
    #image-stream,
    #actions-canvas {
        margin-top: 20px;
        margin-left: 10px;
    }

    #container-div {
        height: 100%;
        width: 100%;
        display: flex;
    }

    #actions-div,
    #source-div,
    #stream-div,
    #element-div {
        display: inline-block;
        *display: inline;
        zoom: 1;
        vertical-align: top;
        visibility: hidden;
    }

    #actions-div {
        width: 25%;
        max-width: 650px;
        margin-left: 10px;
    }

    #source-div {
        margin-left: 20px;
        /* border: 1px solid #000; */
    }

    #device-info-table,
    #element-info-table,
    th,
    td {
        border: 1px solid black;
        border-collapse: collapse;
    }

    td {
        text-align: center;
    }

    #loading {
        visibility: hidden;
        position: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        text-align: center;
        opacity: 0.7;
        background-color: #fff;
        z-index: 99;
    }

    #loading-image {
        position: relative;
    }

    #small-loader {
        visibility: hidden;
        position: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        text-align: center;
        opacity: 0.7;
        background-color: #fff;
        z-index: 99;
    }

    #small-loader-image {
        position: relative;
    }

    #app-source {
        width: 100%;
        margin-left: 10px;
    }

    #app-source {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    ul.fancytree-container {
        border: none;
    }

    span.fancytree-title {
        font-size: 18px;
    }
</style>

<body>
    <div id="loading">
        <img id="loading-image" src="/static/images/loader.gif">
    </div>
    <div class="topnav">
        <link href="/static/css/top_navigation_style.css" rel="stylesheet">
        <a href="/">Home</a>
        <a href="configuration.html">Project configuration</a>
        <a href="ios-containers.html">iOS containers</a>
        <a href="android-containers.html">Android containers</a>
        <a href="project-logs.html">Project logs</a>
        <a class="active" href="device-control.html">Device Control</a>
        <a href="swagger/index.html" target="_blank">Swagger</a>
    </div>
    <div>Please select a device
        <select id="device-dropdown" name="devices" onchange="updateDeviceInfo()"></select>
    </div>
    <div id="container-div">
        <div id="stream-div" style="position: relative;">
            <div id="small-loader" style="visibility: hidden;position: absolute;">
                <img id="small-loader-image" src="/static/images/small-loader.gif">
            </div>
            <canvas id="actions-canvas" style="position: absolute;"></canvas>
            <img id="image-stream"></img>
        </div>
        <div id="actions-div">
            <h3>Device Config Info</h3>
            <table id="device-info-table" style="width:100%">
                <tr>
                    <th>Device model:</th>
                    <td id="device-model"></td>
                </tr>
                <tr>
                    <th>Device name:</th>
                    <td id="device-name"></td>
                </tr>
                <tr>
                    <th>Device OS version:</th>
                    <td id="device-os-version"></td>
                </tr>
                <tr>
                    <th>Device UDID:</th>
                    <td id="device-udid"></td>
                </tr>
                <tr>
                    <th>Appium Port:</th>
                    <td id="appium-port"></td>
                </tr>
                <tr>
                    <th>WDA Port:</th>
                    <td id="wda-port"></td>
                </tr>
                <tr>
                    <th>WDA Mjpeg Port:</th>
                    <td id="wda-mjpeg-port"></td>
                </tr>
                <tr>
                    <th>WDA URL:</th>
                    <td id="wda-url"></td>
                </tr>
                <tr>
                    <th>WDA Stream URL:</th>
                    <td id="wda-stream-url"></td>
                </tr>
                <tr>
                    <th>WDA session ID:</th>
                    <td id="wda-session-id">No session</td>
                </tr>
                <tr>
                    <th>Device size</th>
                    <th id="device-size"></th>
                </tr>
            </table>
            <div>
                <h4>Installed apps</h4>
                <select id="installed-apps-dropdown" name="installed-apps"></select>
                <button id="uninstall-app" onclick="uninstallApp()">Uninstall app</button>
            </div>
            <div>
                <h4>Installable apps</h4>
                <select id="installable-apps-dropdown" name="installable-apps"></select>
                <button id="install-app" onclick="installApp()">Install app</button>
            </div>
            <div>
                <h4>Get app source</h4>
                <button id="get-app-source" onclick="getAppSource()">Get app source</button>
            </div>
            <div>
                <h4>Element interactions</h4>
                <select id="element-query-type">
                    <option value="xpath" selected>Xpath</option>
                    <option value="class chain">Class chain</option>
                    <option value="accessibility id">Accessibility ID</option>
                    <option value="predicate string">Predicate string</option>
                </select>
                <input id="element-query" type="text"></input>
                <button id="query-elements" onclick="createElementsDropdown()">
                    Query elements
                </button></br>
                <select id="found-elements-dropdown" onchange="drawRectangle()"
                    style="visibility: hidden;"></select></br>
                <button id="tap-element" onclick="tapElement()">
                    Tap element
                </button>
                <button onclick="clearCanvas()">Clear canvas</button>
            </div>
        </div>
        <div id="source-div" style="border: 1px solid #000; padding: 10px;">
            <div style="width: 600px;height: 1000px;overflow: auto;">
                <h3>App source</h3>
                <div id="app-source"></div>
            </div>
        </div>
        <div id="element-div" style="border: 1px solid #000; padding: 10px;margin-left: 5px;">
            <div style="width: 600px;height: 600px;overflow: auto;">
                <h3>Selected element</h3>
                <div id="selected-element">Select an element from the app source
                    <table id="element-info-table" style="width:100%; visibility: hidden;">
                        <tr>
                            <th style="width: 50%;">type</th>
                            <td id="element-type"></td>
                        </tr>
                        <tr>
                            <th>name</th>
                            <td id="element-name"></td>
                        </tr>
                        <tr>
                            <th>label</th>
                            <td id="element-label"></td>
                        </tr>
                        <tr>
                            <th>visible</th>
                            <td id="element-visible"></td>
                        </tr>
                        <tr>
                            <th>enabled</th>
                            <td id="element-enabled"></td>
                        </tr>
                        <tr>
                            <th>value</th>
                            <td id="element-value"></td>
                        </tr>
                        <tr>
                            <th>x</th>
                            <td id="element-x"></td>
                        </tr>
                        <tr>
                            <th>y</th>
                            <td id="element-y"></td>
                        </tr>
                        <tr>
                            <th>width</th>
                            <td id="element-width"></td>
                        </tr>
                        <tr>
                            <th>height</th>
                            <td id="element-height"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/jquery.fancytree-all.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/jquery.fancytree-all-deps.min.js"></script>
</body>

<script>
    window.addEventListener("DOMContentLoaded", function () {
        getDeviceControlInfo();
    });

    function getDeviceControlInfo() {
        $.ajax({
            async: false,
            type: "GET",
            url: "/devices/device-control",
            success: function (data) {
                createDeviceDropdown(data)
            },
            error: function (data) {
                alert("Broken data");
            }
        });
    }

    function updateDeviceInfo(data) {
        $('#loading').css("visibility", "visible");

        $.ajax({
            async: false,
            type: "GET",
            url: "/devices/device-control",
            success: function (data) {
                // Get the device UDID from the value of the selected option
                var device_udid = $("#device-dropdown").val();

                var response = JSON.parse(data)
                for (let i = 0; i < response["ios-devices-info"].length; i++) {
                    if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                        $("#device-name").text(response["ios-devices-info"][i].deviceConfig.device_name)
                        $("#device-os-version").text(response["ios-devices-info"][i].deviceConfig.device_os_version)
                        $("#device-udid").text(response["ios-devices-info"][i].deviceConfig.device_udid)
                        $("#appium-port").text(response["ios-devices-info"][i].deviceConfig.appium_port)
                        $("#wda-port").text(response["ios-devices-info"][i].deviceConfig.wda_port)
                        $("#wda-mjpeg-port").text(response["ios-devices-info"][i].deviceConfig.wda_mjpeg_port)
                        $("#wda-stream-url").text(response["ios-devices-info"][i].deviceConfig.wda_stream_url)
                        $("#wda-url").text(response["ios-devices-info"][i].deviceConfig.wda_url)
                        $("#device-size").text(response["ios-devices-info"][i].deviceConfig.viewport_size)
                        $("#device-model").text(response["ios-devices-info"][i].deviceConfig.device_model)
                    }
                }
                createIOSAppsDropdown(data)
                createInstallableAppsDropdown(data)
                checkWDASession()
                updateIOSStreamSize()
                changeStream();
                $('#actions-div').css("visibility", "visible")
                $('#stream-div').css("visibility", "visible")
                $('#source-div').css("visibility", "visible")
                $('#element-div').css("visibility", "visible")
                $('#loading').css("visibility", "hidden");
            },
            error: function (data) {
                $('#loading').css("visibility", "hidden");
            }
        });
    }

    function createDeviceDropdown(data) {
        let device_dropdown = $('#device-dropdown');

        device_dropdown.empty();

        device_dropdown.append('<option>Choose device</option>');

        device_dropdown.prop('selectedIndex', 0);
        var response = JSON.parse(data)
        for (let i = 0; i < response["running-containers"].length; i++) {
            var match = response["running-containers"][i].match(/[^-]*$/)
            device_dropdown.append($('<option></option>').attr('value', match[0]).text(response["running-containers"][i]));
        }
    }

    function updateIOSStreamSize() {
        // Set max height of 850 pixels for the stream element
        let maxHeight = 850

        // Get the actual device dimensions
        let deviceSize = $("#device-size").text()
        let dimensions = deviceSize.split('x');

        let stream_width = ""
        let stream_height = ""

        // if the height of the device is less than the max height of the stream element
        // just set the stream size to the original device size
        if (dimensions[1] < maxHeight) {
            stream_width = dimensions[0] + "px"
            stream_height = dimensions[1] + "px"
        } else {
            // else if the height of the device is more than the max height of the stream element
            // get the actual device screen ratio
            let device_ratio = dimensions[0] / dimensions[1]

            // Set the stream height to the max height
            stream_height = maxHeight
            // set the stream width based on the max height and device ratio
            stream_width = maxHeight * device_ratio
        }


        $("#image-stream").attr('width', stream_width).attr('height', stream_height)
        $("#actions-canvas").attr('width', stream_width).attr('height', stream_height)
    }

    function createIOSAppsDropdown(data) {
        var device_udid = $("#device-dropdown").val();

        let apps_dropdown = $('#installed-apps-dropdown');
        apps_dropdown.empty();
        apps_dropdown.prop('selectedIndex', 0);

        var response = JSON.parse(data)
        for (let i = 0; i < response["ios-devices-info"].length; i++) {
            if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                for (let x = 0; x < response["ios-devices-info"][i].installedAppsBundleIDs.length; x++) {
                    apps_dropdown.append($('<option></option>').attr('value', response["ios-devices-info"][i].installedAppsBundleIDs[x]).text(response["ios-devices-info"][i].installedAppsBundleIDs[x]));
                }
            }
        }
    }

    function createInstallableAppsDropdown(data) {
        // Get the device UDID from the value of the selected option
        var device_udid = $("#device-dropdown").val();

        let apps_dropdown = $('#installable-apps-dropdown');

        let container_name = $("#device-dropdown option:selected").text()

        apps_dropdown.empty();
        apps_dropdown.prop('selectedIndex', 0);

        var response = JSON.parse(data)
        for (let i = 0; i < response["installable-apps"].length; i++) {
            if (container_name.includes("ios_device") && response["installable-apps"][i].includes(".ipa") || response["installable-apps"][i].includes(".app")) {
                apps_dropdown.append($('<option></option>').attr('value', response["installable-apps"][i]).text(response["installable-apps"][i]));
            } else if (container_name.includes("android_device") && response["installable-apps"][i].includes(".apk")) {
                apps_dropdown.append($('<option></option>').attr('value', response["installable-apps"][i]).text(response["installable-apps"][i]));
            }
        }
    }

    function changeStream() {
        var device_udid = $("#device-dropdown").val();
        let image_stream = $('#image-stream')
        $.ajax({
            async: false,
            type: "GET",
            url: "/devices/device-control",
            success: function (data) {
                var response = JSON.parse(data)
                for (let i = 0; i < response["ios-devices-info"].length; i++) {
                    if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                        image_stream.attr('src', response["ios-devices-info"][i].deviceConfig.wda_stream_url)
                    }
                }
            }
        });
    }

    function uninstallApp() {
        var bundle_id = $('#installed-apps-dropdown').val();
        var device_udid = $("#device-dropdown").val();

        $.ajax({
            contentType: 'application/json',
            async: true,
            type: "POST",
            data: JSON.stringify({ "bundle_id": bundle_id }),
            url: "/ios-devices/" + device_udid + "/uninstall-app",
            success: function (data) {
                swal("Info message", "Successfully uninstalled app with bundleID:'" + bundle_id + "'", "success")
                    .then(() => {
                        location.reload();
                    });
            },
            error: function (data) {
                swal("Uninstall app error", $.parseJSON(data.responseText).error_message, "error")
            }
        });
    }

    function installApp() {
        var ipa_name = $('#installable-apps-dropdown').val();
        var device_udid = $("#device-dropdown").val();

        $('#loading').css("visibility", "visible");

        $.ajax({
            contentType: 'application/json',
            async: true,
            type: "POST",
            data: JSON.stringify({ "ipa_name": ipa_name }),
            url: "/ios-devices/" + device_udid + "/install-app",
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                swal("Install app", "Successfully installed app :'" + ipa_name + "'", "success")
                    .then(() => {
                        location.reload();
                    });
            },
            error: function (data) {
                $('#loading').css("visibility", "hidden");
                swal($.parseJSON(data.responseText).event, $.parseJSON(data.responseText).error_message, "error")
            }
        });
    }

    // check if a wda session exists and connect to it or create a new one
    function checkWDASession() {
        let wda_url = $("#wda-url").text()
        let wda_session_el = $("#wda-session-id")

        // if there is no session id from the /status endpoint create a new session
        // else just update the session id in the table with the existing session
        $.ajax({
            type: "GET",
            url: wda_url + "/status",
            success: function (data) {
                if (data.sessionId === null) {
                    createWDASession()
                } else {
                    wda_session_el.text(data.sessionId)
                }
            },
            error: function (data) {
                console.log("could not get session")
            }
        });
    }

    // create a wda session to the iOS device if no session exists
    function createWDASession() {
        let wda_url = $("#wda-url").text()
        let wda_session = $("#wda-session-id")
        let json = ""

        // build the json to create a session
        json = JSON.stringify({
            "capabilities": {
                "firstMatch": [
                    {
                        "arguments": [],
                        "environment": {},
                        "eventloopIdleDelaySec": 0,
                        "shouldWaitForQuiescence": true,
                        "shouldUseTestManagerForVisibilityDetection": false,
                        "maxTypingFrequency": 60,
                        "shouldUseSingletonTestManager": true,
                        "shouldTerminateApp": true,
                        "forceAppLaunch": true,
                        "useNativeCachingStrategy": true,
                        "forceSimulatorSoftwareKeyboardPresence": false
                    }
                ],
                "alwaysMatch": {}
            }
        })

        // show a loading while creating session
        $('#loading').css("visibility", "visible");

        // create the new session
        // on success update the wda session id in the table
        $.ajax({
            type: "POST",
            url: wda_url + "/session",
            data: json,
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                wda_session.text(data.sessionId)
            },
            error: function (data) {
                $('#loading').css("visibility", "hidden");
                swal("Error", "Could not start session for bundleID:" + bundle_id, "error")
            }
        });
    }

    //
    function getAppSource() {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()
        let app_source = $("#app-source")
        parser = new DOMParser();

        $('#loading').css("visibility", "visible");

        $.ajax({
            async: true,
            type: "GET",
            url: wda_url + "/session/" + wda_session_id + "/source",
            success: function (data) {
                $('#loading').css("visibility", "hidden");

                // parse the xml doc from the Appium response xml
                xmlDoc = parser.parseFromString(data.value, "text/xml");

                // parse the xml response into a json format accepted by jstree
                var jstree_json = generateJSONForTreeFromXML(xmlDoc.documentElement)

                // If the tree already exists and has children - reload it with the new data
                // If the tree doesn't exist or doesn't have children - initialize it for the first time with the needed options
                if (app_source.children().length > 0) {
                    $.ui.fancytree.getTree().reload(JSON.parse(jstree_json));
                } else {
                    app_source.fancytree({
                        'source': [
                            JSON.parse(jstree_json)
                        ],
                        activate: function (event, data) {
                            var element_values = JSON.parse(data.node.key.replaceAll("'", "\""))
                            showElementInfo(element_values)
                            drawRectangleForTree(element_values)
                        }
                    });
                }
            },
            error: function () {
                $('#loading').css("visibility", "hidden");
                app_source.text("Couldn't get app source")
            }
        });
    }

    // read the Appium xml and transform it into a json accepted by fancytree
    function generateJSONForTreeFromXML(node) {
        if (node.nodeType != 1) return "";

        // Get all the data from the xml doc returned by Appium
        var elemType = node.getAttribute('type')
        var elemX = node.getAttribute('x')
        var elemY = node.getAttribute('y')
        var elemWidth = node.getAttribute('width')
        var elemHeight = node.getAttribute('height')
        var elemName = node.getAttribute('name')
        var elemLabel = node.getAttribute('label')
        var elemVisible = node.getAttribute('visible')
        var elemEnabled = node.getAttribute('enabled')
        var elemValue = node.getAttribute('value')

        // this is not a valid json but this is the only way I could find to embed it inside another json (bad developer)
        // it is reworked later into valid json that can be parsed
        value_json = `{'type':'` + elemType + `',` +
            `'x':'` + elemX + `',` +
            `'y':'` + elemY + `',` +
            `'width':'` + elemWidth + `',` +
            `'height':'` + elemHeight + `',` +
            `'name':'` + elemName + `',` +
            `'label':'` + elemLabel + `',` +
            `'visible':'` + elemVisible + `',` +
            `'enabled':'` + elemEnabled + `',` +
            `'value':'` + elemValue + `'}`

        // for each node open with an object
        // the key is the "json" (quotes intended) that will we will read later upon clicking a node in the tree
        // no icons since its not a folder/file structure
        // no lazy loading - the whole tree is loaded
        // no default active nodes in the tree
        // title is the element type
        var mainJson = `{"key":"` + value_json + `", "icon": false, "lazy": false, "active": false,"title":"` + node.nodeName + `"`
        var jsonForChildNodes = "";

        // if the node has children open the children array
        if (node.childNodes.length > 0) {
            mainJson += `, "children":[`
        }
        for (var i = 0; i < node.childNodes.length; i++) {
            // for each child of the main node generate deeper json objects
            jsonForChildNodes += generateJSONForTreeFromXML(node.childNodes[i]);
        }
        if (jsonForChildNodes) {
            // close the children array
            mainJson += jsonForChildNodes + `]`
        }
        // close the json object
        mainJson += `}`

        // cus I am a bad developer I couldn't think of the proper way to 
        // build the json with all needed commas so I invented this solution
        // to add the missing commas to make the json valid xD
        mainJson = mainJson.replaceAll("}{", "},{")
        return mainJson;
    }

    // Present the element info table with all the values
    function showElementInfo(json) {
        $("#element-info-table").css("visibility", "visible")
        $("#element-type").text(json.type)
        $("#element-name").text(json.name)
        $("#element-label").text(json.label)
        $("#element-value").text(json.value)
        $("#element-enabled").text(json.enabled)
        $("#element-visible").text(json.visible)
        $("#element-x").text(json.x)
        $("#element-y").text(json.y)
        $("#element-width").text(json.width)
        $("#element-height").text(json.height)
    }

    // get the element coordinates and size from fancytree node value and build a rectangle on the stream canvas
    // showing the selected element
    function drawRectangleForTree(json) {
        clearCanvas()
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.strokeStyle = '#fc0303'
        context.lineWidth = 2;

        // get the selected element coordinates and size from the json
        var elementX = json.x;
        var elementY = json.y;
        var elementWidth = json.width;
        var elementHeight = json.height;

        // draw a rectangle on the canvas stream surrounding the element
        context.strokeRect(
            elementX,
            elementY,
            elementWidth,
            elementHeight
        );
    }

    // search for elements by locator strategy
    function createElementsDropdown() {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()
        let query_type = $('#element-query-type option:selected').val();
        let query_string = $("#element-query").val()
        let found_elements = $('#found-elements-dropdown');

        // clear the dropdown if you already have a search
        found_elements.empty();
        found_elements.prop('selectedIndex', 0);

        // create the json to search for element by locator strategy and value
        let json = JSON.stringify({
            "using": query_type,
            "value": query_string
        })

        // show loading while searching
        $('#loading').css("visibility", "visible");

        // call the /elements endpoint with the query
        $.ajax({
            async: true,
            type: "POST",
            data: json,
            url: wda_url + "/session/" + wda_session_id + "/elements",
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                if (data.value.length == 0) {
                    // if response is success but no elements - show no elements in dropdown
                    found_elements.append($('<option></option>').text("No elements found"));
                    $("#found-elements-dropdown").css("visibility", "visible")
                } else {
                    // if response is success and has elements - build the dropdown with their session ids
                    found_elements.append('<option>Choose element</option>');
                    for (let i = 0; i < data.value.length; i++) {
                        $('#loading').css("visibility", "hidden");
                        found_elements.append($('<option></option>').attr('value', data.value[i].ELEMENT).text(data.value[i].ELEMENT));
                        $("#found-elements-dropdown").css("visibility", "visible")
                    }
                }
            },
            error: function () {
                // show could not get elements if something is wrong with the request
                $('#loading').css("visibility", "hidden");
                found_elements.append($('<option></option>').text("Could not get elements"));
                $("#found-elements-dropdown").css("visibility", "visible")
            }
        });
    }

    // Tap element from found elements dropdown
    function tapElement() {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()
        let element_id = $('#found-elements-dropdown option:selected').val();

        /* Show loading indicator until response is returned */
        $('#loading').css("visibility", "visible");

        // call the click endpoint using the element id from the dropdown
        $.ajax({
            async: true,
            type: "POST",
            data: "{}",
            url: wda_url + "/session/" + wda_session_id + "/element/" + element_id + "/click",
            success: function () {
                $('#loading').css("visibility", "hidden");
            },
            error: function () {
                $('#loading').css("visibility", "hidden");
            }
        });
    }

    //=============CANVAS INTERACTIONS===================//
    // canvas over the WDA image stream that allows us to tap
    // and also draw element rectangles
    var canvas = document.getElementById("actions-canvas")

    // remove anything drawn on the canvas
    function clearCanvas() {
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.clearRect(0, 0, canvas.width, canvas.height);
    }

    // draw rectangle on the canvas for element found by search for element
    function drawRectangle() {
        // clear the canvas in case something is already drawn on it
        clearCanvas()

        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()
        let element_id = $("#found-elements-dropdown").val();

        // set canvas context, stroke style and stroke width
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.strokeStyle = '#d2eb34'
        context.lineWidth = 2;

        var elementX = "";
        var elementY = "";
        var elementWidth = "";
        var elementHeight = "";

        // get the coordinates of the selected element by the element ID generated by Appium
        $.ajax({
            async: false,
            type: "GET",
            url: wda_url + "/session/" + wda_session_id + "/element/" + element_id + "/rect",
            success: function (data) {
                elementX = data.value.x
                elementY = data.value.y
                elementWidth = data.value.width
                elementHeight = data.value.height
            }
        });

        // draw a rectangle on the stream canvas surrounding the selected element
        context.strokeRect(
            elementX,
            elementY,
            elementWidth,
            elementHeight
        );
    }

    // perform tap on canvas
    canvas.onmousedown = function (event) {
        var pos = getTapCoordinates(canvas, event);
        tapCoordinates(pos)
    }

    // get the coordinates of the cursor position of the canvas tap event
    function getTapCoordinates(canvas, event) {
        // get the canvas rectangle and then the coordinates of the tap event
        const rect = canvas.getBoundingClientRect()
        const x = event.clientX - rect.left
        const y = event.clientY - rect.top
        return [x, y];
    }

    // tap with WDA using coordinates
    function tapCoordinates(pos) {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()

        // get stream size and ratio
        let stream_height = $("#actions-canvas").height()
        let stream_width = $("#actions-canvas").width()
        let stream_size_ratio = (stream_height / stream_width).toFixed(2)

        let deviceSize = $("#device-size").text()
        let dimensions = deviceSize.split('x');
        let deviceHeight = parseInt(dimensions[1], 10)

        let x = pos[0]
        let y = pos[1]

        if (stream_height != deviceHeight) {
            x = pos[0] * stream_size_ratio
            y = pos[1] * stream_size_ratio
        }

        // build the json accepted by the /actions Appium endpoint used by the Appium Inspector
        let jsonData = JSON.stringify({
            "actions": [
                {
                    "type": "pointer",
                    "id": "finger1",
                    "parameters": {
                        "pointerType": "touch"
                    },
                    "actions": [
                        {
                            "type": "pointerMove",
                            "duration": 0,
                            "x": x,
                            "y": y
                        },
                        {
                            "type": "pointerDown",
                            "button": 0
                        },
                        {
                            "type": "pause",
                            "duration": 200
                        },
                        {
                            "type": "pointerUp",
                            "button": 0
                        }
                    ]
                }
            ]
        })

        // show a loader on the canvas until the tap action response is returned
        // this is to prevent fast tapping that will not be handled properly
        showCanvasLoader()

        // call the /actions endpoint sending the tapp coordinates
        // on response remove the canvas loader
        $.ajax({
            async: false,
            type: "POST",
            data: jsonData,
            url: wda_url + "/session/" + wda_session_id + "/actions",
            success: function () {
                hideCanvasLoader()
            },
            error: function () {
                hideCanvasLoader()
                alert("WDA session is invalid, please reload")
            }
        });
    }

    // present a loader and semi-transparent overlay on the canvas while waiting for the tap response
    // block canvas interaction while waiting
    function showCanvasLoader() {
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.fillStyle = "rgba(204, 201, 194, 0.4)";
        context.fillRect(0, 0, canvas.width, canvas.height);
        $('#actions-canvas').css("cursor: not-allowed;pointer-events: none;")
        $('#small-loader-image').css("visibility", "visible");
    }

    // remove the canvas loader
    // and allow canvas interactions again
    function hideCanvasLoader() {
        clearCanvas()
        $('#small-loader-image').css("visibility", "hidden");
        $('#actions-canvas').css("cursor: allowed;pointer-events: all;")
    }

</script>

</html>